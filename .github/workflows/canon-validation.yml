name: Canon Validation

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  canon-tests:
    name: Canon Law Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Validate canon.json schema
        run: |
          python -c "import json; json.load(open('canon/canon.json'))"
          echo "✓ canon.json is valid JSON"

      - name: Test canon imports
        run: |
          python -c "from canon.canon import COLORS, is_adjacent, validate_sequence; print('✓ Canon module imports successfully')"

      - name: Test adjacency validator
        run: |
          python -c "
          from canon.canon import is_adjacent
          # Test valid transitions
          assert is_adjacent(0, 1), 'Forward transition failed'
          assert is_adjacent(1, 0), 'Backward transition failed'
          assert is_adjacent(6, 0), 'Wrap-around failed'
          # Test invalid transitions
          assert not is_adjacent(0, 2), 'Illegal jump not detected'
          assert not is_adjacent(0, 4), 'Illegal jump not detected'
          print('✓ Adjacency validator working correctly')
          "

      - name: Test valid sequences
        run: |
          ./codex check tests/test_sequences/valid_forward.txt
          ./codex check tests/test_sequences/valid_sequence.json

      - name: Test invalid sequences (should fail)
        run: |
          # This should exit with code 1 (failure)
          if ./codex check tests/test_sequences/invalid_jump.txt; then
            echo "❌ Invalid sequence was not detected!"
            exit 1
          else
            echo "✓ Invalid sequence correctly detected"
          fi

      - name: Run unit tests (if they exist)
        run: |
          if [ -d "tests" ] && [ -f "tests/test_canon.py" ]; then
            python -m pytest tests/ -v
          else
            echo "⚠ No pytest tests found (optional)"
          fi

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    needs: canon-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hypothesis pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run property tests
        run: |
          if [ -f "tests/test_properties.py" ]; then
            python -m pytest tests/test_properties.py -v
          else
            echo "⚠ Property tests not yet implemented (optional)"
          fi

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install black flake8

      - name: Check formatting with black
        run: |
          if ls canon/*.py src/**/*.py 2>/dev/null; then
            black --check canon/ src/ || echo "⚠ Code not formatted with black (run 'black canon/ src/')"
          fi

      - name: Lint with flake8
        run: |
          if ls canon/*.py src/**/*.py 2>/dev/null; then
            flake8 canon/ src/ --max-line-length=100 --ignore=E501,W503 || echo "⚠ Linting issues found"
          fi

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required docs exist
        run: |
          test -f docs/CANON.md || (echo "❌ docs/CANON.md missing" && exit 1)
          test -f docs/GLOSSARY.md || (echo "❌ docs/GLOSSARY.md missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "❌ CONTRIBUTING.md missing" && exit 1)
          echo "✓ Required documentation files present"

      - name: Check for canon definition
        run: |
          grep -q "±1 mod 7" docs/CANON.md || (echo "❌ Adjacency law not documented in CANON.md" && exit 1)
          echo "✓ Canon documentation complete"
